<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diabetes AI Test</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        .box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .citation { background: #f9f9f9; padding: 10px; margin-top: 10px; border-left: 4px solid #007bff; font-size: 0.9em; }
        button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>
    <h1>ü§ñ Diabetes RAG Tester</h1>
    
    <div>
        <input type="text" id="question" placeholder="e.g., What are the symptoms of Type 2?" style="width: 70%; padding: 10px;">
        <button id="askBtn" onclick="askBackend()">Ask Groq</button>
    </div>

    <div id="status" style="margin-top: 10px; color: gray;">Server Status: Checking...</div>

    <div id="resultArea" style="display: none;">
        <div class="box">
            <h3>Answer:</h3>
            <p id="answerText"></p>
        </div>

        <div id="citationsArea"></div>
    </div>

    <script>
        // 1. Check if Server is Online immediately
        fetch("http://127.0.0.1:8000/")
            .then(res => res.json())
            .then(data => document.getElementById("status").innerText = "‚úÖ Server Online: " + data.message)
            .catch(err => document.getElementById("status").innerHTML = "‚ùå <span style='color:red'>Server Offline (Is uvicorn running?)</span>");

        // 2. Function to call your API
        async function askBackend() {
            const question = document.getElementById("question").value;
            const btn = document.getElementById("askBtn");
            const resultArea = document.getElementById("resultArea");
            const answerText = document.getElementById("answerText");
            const citationsArea = document.getElementById("citationsArea");

            if (!question) return alert("Please type a question!");

            // UI Loading State
            btn.disabled = true;
            btn.innerText = "Thinking...";
            resultArea.style.display = "none";
            citationsArea.innerHTML = "";

            try {
                // CALL YOUR FASTAPI BACKEND
                const response = await fetch("http://127.0.0.1:8000/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ question: question })
                });

                if (!response.ok) throw new Error("API Error: " + response.statusText);

                const data = await response.json();

                // Show Answer
                resultArea.style.display = "block";
                answerText.innerText = data.answer;

                // Show Citations
                if (data.citations && data.citations.length > 0) {
                    let html = "<h3>üìö Sources Used:</h3>";
                    data.citations.forEach(cit => {
                        html += `
                        <div class="citation">
                            <strong>üìÑ ${cit.title}</strong> (Page ${cit.page})<br>
                            <em>"${cit.snippet}"</em>
                        </div>`;
                    });
                    citationsArea.innerHTML = html;
                } else {
                    citationsArea.innerHTML = "<p><em>No specific sources cited.</em></p>";
                }

            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Ask Groq";
            }
        }
    </script>
</body>
</html>